-- BASE DE DATOS

USE MODELO;
GO

-- CLIENTES

INSERT INTO CLIENTE(IDCLIENTE,NOMCLIENTE) VALUES(1,'GUSTAVO');
INSERT INTO CLIENTE(IDCLIENTE,NOMCLIENTE) VALUES(2,'ADELA');
INSERT INTO CLIENTE(IDCLIENTE,NOMCLIENTE) VALUES(3,'VICTOR');
INSERT INTO CLIENTE(IDCLIENTE,NOMCLIENTE) VALUES(4,'YESSENIA');
INSERT INTO CLIENTE(IDCLIENTE,NOMCLIENTE) VALUES(5,'ZULMA');
GO

-- PRODUCTOS

INSERT INTO PRODUCTO(IDPRODUCTO,NOMPRODUCTO,PRECIOVENTA) VALUES(100,'PRODUCTO A', 90.0);
INSERT INTO PRODUCTO(IDPRODUCTO,NOMPRODUCTO,PRECIOVENTA) VALUES(200,'PRODUCTO B', 85.0);
INSERT INTO PRODUCTO(IDPRODUCTO,NOMPRODUCTO,PRECIOVENTA) VALUES(300,'PRODUCTO C', 230.0);
INSERT INTO PRODUCTO(IDPRODUCTO,NOMPRODUCTO,PRECIOVENTA) VALUES(400,'PRODUCTO D', 176.0);
INSERT INTO PRODUCTO(IDPRODUCTO,NOMPRODUCTO,PRECIOVENTA) VALUES(500,'PRODUCTO E', 130.0);
GO

-- PEDIDOS

INSERT INTO PEDIDO(IDPEDIDO,FECHA,IDCLIENTE,SUBTOTAL,IMPUESTO,TOTAL) VALUES(1001,GETDATE()-20,2,0,0,0);
INSERT INTO PEDIDO(IDPEDIDO,FECHA,IDCLIENTE,SUBTOTAL,IMPUESTO,TOTAL) VALUES(1002,GETDATE()-15,4,0,0,0);
INSERT INTO PEDIDO(IDPEDIDO,FECHA,IDCLIENTE,SUBTOTAL,IMPUESTO,TOTAL) VALUES(1003,GETDATE()-10,2,0,0,0);
GO

-- DETALLE PEDIDO 1001

INSERT INTO DETALLE_PEDIDO(IDPEDIDO,IDPRODUCTO,CANTIDAD,PRECIONETO,IMPORTE) VALUES(1001,200,3,1,1);
INSERT INTO DETALLE_PEDIDO(IDPEDIDO,IDPRODUCTO,CANTIDAD,PRECIONETO,IMPORTE) VALUES(1001,500,4,1,1);
GO

-- DETALLE PEDIDO 1002

INSERT INTO DETALLE_PEDIDO(IDPEDIDO,IDPRODUCTO,CANTIDAD,PRECIONETO,IMPORTE) VALUES(1002,200,1,1,1);
INSERT INTO DETALLE_PEDIDO(IDPEDIDO,IDPRODUCTO,CANTIDAD,PRECIONETO,IMPORTE) VALUES(1002,400,2,1,1);
INSERT INTO DETALLE_PEDIDO(IDPEDIDO,IDPRODUCTO,CANTIDAD,PRECIONETO,IMPORTE) VALUES(1002,500,3,1,1);
GO

-- DETALLE PEDIDO 1003

INSERT INTO DETALLE_PEDIDO(IDPEDIDO,IDPRODUCTO,CANTIDAD,PRECIONETO,IMPORTE) VALUES(1003,100,4,1,1);
INSERT INTO DETALLE_PEDIDO(IDPEDIDO,IDPRODUCTO,CANTIDAD,PRECIONETO,IMPORTE) VALUES(1003,300,3,1,1);
INSERT INTO DETALLE_PEDIDO(IDPEDIDO,IDPRODUCTO,CANTIDAD,PRECIONETO,IMPORTE) VALUES(1003,400,2,1,1);
GO

-- Actualizar precio en DETALLE_PEDIDO

UPDATE DETALLE_PEDIDO
SET PRECIONETO = P.PRECIOVENTA
FROM DETALLE_PEDIDO D
JOIN PRODUCTO P ON D.IDPRODUCTO = P.IDPRODUCTO;
GO

-- Actualizar importe en DETALLE_PEDIDO
UPDATE DETALLE_PEDIDO
SET IMPORTE = PRECIONETO * CANTIDAD;
GO

-- ACTUALIZAR EL TOTAL DEL PEDIDO
UPDATE PEDIDO 
SET TOTAL = D.IMPORTE
FROM PEDIDO P
JOIN (SELECT IDPEDIDO, SUM(IMPORTE) IMPORTE FROM DETALLE_PEDIDO GROUP BY IDPEDIDO) D
ON P.IDPEDIDO = D.IDPEDIDO;
GO

-- Actualizar el subtotal del PEDIDO
UPDATE PEDIDO SET SUBTOTAL = TOTAL / 1.18;

-- Actualizar el impuesto del PEDIDO
UPDATE PEDIDO SET IMPUESTO = TOTAL - SUBTOTAL;

-- Consulta de un pedido
declare @pedido int;
set @pedido = 1003;
select * from pedido where IDPEDIDO = @pedido;
select * from DETALLE_PEDIDO where IDPEDIDO = @pedido;
go
